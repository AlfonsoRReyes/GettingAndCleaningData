# CodeBook.md



# About the data and the sources
Human Activity Recognition Using Smartphones Dataset

## Measurements
The obtained dataset has been randomly partitioned into two sets, where 70% of the volunteers was selected for generating the training data and 30% the test data. The training data is located under the `train` folder and has been named `X_train.txt`. The test data is located under the `test` folder with the file named `X_test.txt` These files contain 561 variable names that were generated by the sensors.


## The sensors
There are two sensors from which the data is acquired: an __accelerometer__ and a __gyroscope__. Triaxal acceleration readings are collected from the accelerometer, while angular velocity in the tree axis are read from the gyroscope. Additionally these measurements are processed under two domains: time and frequency. All of these measurements total __561 variables__.



# Measurements and Auxiliary Data frames

## The `train` data frame
This shows a summary of the `train` data frame after loading the file `X_train.txt`.


```r
library(dplyr)
```



```r
library(dplyr)
source("run_analysis.R")
train <- read.table("./data/UCI HAR Dataset/train/X_train.txt")    # read test dataset: 62.9 MB
short_summary(train)
```

```
Observations: 	 7352 			First variables: V1 V2 V3 V4 V5 V6 
Variables: 	 561 			Last variables: V556 V557 V558 V559 V560 V561 

First observations
         V1       V141       V281       V421        V561
1 0.2885845 -0.9786140 -0.9747327 -0.9986807 -0.05862692
2 0.2784188 -0.9893447 -0.9858116 -0.9996510 -0.05431672
3 0.2796531 -0.9951443 -0.9858213 -0.9995138 -0.04911782
4 0.2791739 -0.9941653 -0.9928120 -0.9992066 -0.04766318
5 0.2766288 -0.9933367 -0.9924232 -0.9992106 -0.04389225
6 0.2771988 -0.9929940 -0.9950023 -0.9994048 -0.04212638

Summary of selected variables
```

```
       V1               V141              V281              V421        
 Min.   :-1.0000   Min.   :-1.0000   Min.   :-1.0000   Min.   :-1.0000  
 1st Qu.: 0.2630   1st Qu.:-0.9871   1st Qu.:-0.9869   1st Qu.:-0.9995  
 Median : 0.2772   Median :-0.9356   Median :-0.9055   Median :-0.9979  
 Mean   : 0.2745   Mean   :-0.7132   Mean   :-0.5541   Mean   :-0.9291  
 3rd Qu.: 0.2885   3rd Qu.:-0.4954   3rd Qu.:-0.1051   3rd Qu.:-0.9133  
 Max.   : 1.0000   Max.   : 1.0000   Max.   : 1.0000   Max.   : 1.0000  
      V561          
 Min.   :-1.000000  
 1st Qu.:-0.143414  
 Median : 0.003181  
 Mean   :-0.056515  
 3rd Qu.: 0.107659  
 Max.   : 1.000000  
```


## The `test` data frame
This shows a summary of the `test` data frame after loading the file `X_test.txt`.


```r
library(dplyr)
source("run_analysis.R")
test <- read.table("./data/UCI HAR Dataset/test/X_test.txt")    # read test dataset: 25.2 MB
short_summary(test)
```

```
Observations: 	 2947 			First variables: V1 V2 V3 V4 V5 V6 
Variables: 	 561 			Last variables: V556 V557 V558 V559 V560 V561 

First observations
         V1       V141       V281       V421        V561
1 0.2571778 -0.9061043 -0.8650632 -0.9984601 -0.05797830
2 0.2860267 -0.9606847 -0.9576235 -0.9985726 -0.08389801
3 0.2754848 -0.9861989 -0.9771138 -0.9990731 -0.07934620
4 0.2702982 -0.9716812 -0.9786883 -0.9987950 -0.07710800
5 0.2748330 -0.9815836 -0.9829645 -0.9995514 -0.07385681
6 0.2792199 -0.9820461 -0.9827866 -0.9994356 -0.06847070

Summary of selected variables
```

```
       V1               V141              V281              V421         
 Min.   :-0.5920   Min.   :-0.9990   Min.   :-0.9989   Min.   :-0.99999  
 1st Qu.: 0.2621   1st Qu.:-0.9828   1st Qu.:-0.9835   1st Qu.:-0.99944  
 Median : 0.2771   Median :-0.9148   Median :-0.8744   Median :-0.99613  
 Mean   : 0.2740   Mean   :-0.7271   Mean   :-0.5582   Mean   :-0.94097  
 3rd Qu.: 0.2881   3rd Qu.:-0.5329   3rd Qu.:-0.1423   3rd Qu.:-0.91959  
 Max.   : 0.6719   Max.   : 0.5487   Max.   : 0.5770   Max.   :-0.07175  
      V561         
 Min.   :-0.94923  
 1st Qu.:-0.09848  
 Median :-0.01067  
 Mean   :-0.04872  
 3rd Qu.: 0.09237  
 Max.   : 0.97311  
```

## Observations about the data frames for the measurements 
From the short reports printed above, we can appreciate that both data frames `train` with 7352 observations, and `test` with 2947 observations, hold the same number of variables (561), which facilitates the merging operations later. The variable names are the default and are labeled as "Vnnn" where _nnn_ is the variable number from 1 through 561. Later, these variable names will be reassigned with the ones used by the researchers.


## Subjects and Activities
The experiments have been carried out with a group of `30 volunteers` within an age bracket of 19-48 years. Each person performed six activities (`WALKING, WALKING_UPSTAIRS, WALKING_DOWNSTAIRS, SITTING, STANDING, LAYING`) wearing a smartphone.



### Subjects data frame for the `train` dataset
The `subjects` data frame is generated by reading the file `subject_name.txt`, where name could take either of two values: `train` or `test`. We will use this file naming convention in our advantage later by applying one common function to both data frames. Below is shown a short summary of `subjects` data frame.


```r
subject_train <- read.table("./data/UCI HAR Dataset/train/subject_train.txt") 
short_summary(subject_train)
```

```
Observations: 	 7352 			First variables: V1 
Variables: 	 1 			Last variables: V1 

First observations
  V1
1  1
2  1
3  1
4  1
5  1
6  1

Summary of selected variables
```

```
       V1       
 Min.   : 1.00  
 1st Qu.: 8.00  
 Median :19.00  
 Mean   :17.41  
 3rd Qu.:26.00  
 Max.   :30.00  
```


```

Vector Class: integer
```

```
	Subject IDs: 1 3 5 6 7 8 11 14 15 16 17 19 21 22 23 25 26 27 28 29 30
```
Note that the subject IDs for the `train` data frame are not continuous from 1 through 30; some IDs are missing. These IDs will be found in the `test` data frame.



### Subjects data frame for `test` dataset
The `subjects` data frame for `test` is generated by reading the file `subject_test.txt`. Below is shown a short summary of `subjects` data frame for the `test` dataset.


```r
subject_test <- read.table("./data/UCI HAR Dataset/test/subject_test.txt") 
short_summary(subject_test)
```

```
Observations: 	 2947 			First variables: V1 
Variables: 	 1 			Last variables: V1 

First observations
  V1
1  2
2  2
3  2
4  2
5  2
6  2

Summary of selected variables
```

```
       V1       
 Min.   : 2.00  
 1st Qu.: 9.00  
 Median :12.00  
 Mean   :12.99  
 3rd Qu.:18.00  
 Max.   :24.00  
```


```

Vector Class: integer
```

```
	Subject IDs: 2 4 9 10 12 13 18 20 24
```
We now can observe that the subject IDs missing values in the `train` dataset appear in the `test` dataset, which is expected according to the rules of the experiment: _The obtained dataset has been randomly partitioned into two sets, where 70% of the volunteers was selected for generating the training data and 30% the test data._

> Later on, both subjects data frames will be merged with their corresponding measurement data frames, `train` and `test`.


## Activity labels
The activity labels are read from the file `activity_labels.txt`. We show a view of the data frame:


```r
# read activity labels. They are 6 activity label variables
# rows: 6
# V1:   activity ID
# V2:   activity description
# file: "./data/UCI HAR Dataset/activity_labels.txt"
activity_labels <<- read.table("./data/UCI HAR Dataset/activity_labels.txt")
activity_labels
```

```
  V1                 V2
1  1            WALKING
2  2   WALKING_UPSTAIRS
3  3 WALKING_DOWNSTAIRS
4  4            SITTING
5  5           STANDING
6  6             LAYING
```
The activity labels are stored in the second column of the data frame. The first column is the ID. This `ID` will be used later to merge this data frame against the measurement data frames `train` and `test`.


```
[1] "WALKING"            "WALKING_UPSTAIRS"   "WALKING_DOWNSTAIRS"
[4] "SITTING"            "STANDING"           "LAYING"            
```



## Activities data frames for `train` and `test`
In the same way as the `Subjects` data frames for `train` and `test` were structured, there are two data frames that will be used to link the activity being performed by the subject on each of the `nrow(train)` and `nrow(test)` observations, respectively. Let's take a look at the data frames:

__activity_train__


```r
activity_train <- read.table("./data/UCI HAR Dataset/train/y_train.txt") 
short_summary(activity_train)
```

```
Observations: 	 7352 			First variables: V1 
Variables: 	 1 			Last variables: V1 

First observations
  V1
1  5
2  5
3  5
4  5
5  5
6  5

Summary of selected variables
```

```
       V1       
 Min.   :1.000  
 1st Qu.:2.000  
 Median :4.000  
 Mean   :3.643  
 3rd Qu.:5.000  
 Max.   :6.000  
```
As we can see above, there are 7352 observations in this `activity_train` data frame. They correspond exactly with the number of observations of the `train` measurements data frame.

We can also observe that the activity IDs show 6 id numbers even though there are 7352 observations in this data frame.

```r
# uniques ID for the train activity dataframe
sort(unique(activity_train$V1))
```

```
[1] 1 2 3 4 5 6
```

__activity_test__



```r
activity_test <- read.table("./data/UCI HAR Dataset/test/y_test.txt") 
short_summary(activity_test)
```

```
Observations: 	 2947 			First variables: V1 
Variables: 	 1 			Last variables: V1 

First observations
  V1
1  5
2  5
3  5
4  5
5  5
6  5

Summary of selected variables
```

```
       V1       
 Min.   :1.000  
 1st Qu.:2.000  
 Median :4.000  
 Mean   :3.578  
 3rd Qu.:5.000  
 Max.   :6.000  
```
As we can see above, there are 2947 observations in this `activity_test` data frame. They correspond exactly with the number of observations of the `test` measurements data frame.

We can also observe that the activity IDs show 6 id numbers even though there are 2947 observations in this data frame.

```r
# uniques ID for the test activity dataframe
sort(unique(activity_test$V1))
```

```
[1] 1 2 3 4 5 6
```

# Construction and transformations of the data sets for analysis
After taking a look at the auxiliarey data frames for the subject and activities we will move on the measurements data frames. These data frames `train` and `test` contain each 561 variables but both with different amount of observations.

These data frames are in a raw form as describe here:

* They do not have descriptive names for the variables
* The measurements do not have any sort of ID variable for the subject under analysis or an ID for any kind of actovity being performed by the subject. 
* No siginificant analysis can be performed on any of these data frames; we only know that the variables are numerical.

We will need to perform several operations to have the data frames `train` and `test` ready for analysis. The operations are:

1. Read the variables names 
2. Find that all variable names are unique using function `compose_features()`
3. Mark variable names that are repeating
4. Find why the variable is repeating its name
5. Fix the names of the repeating variables
6. Convert the variable names to *nice* variables names using function `make_nice_variables()`
7. Merge the data frame with corrected variable names with the measurement data frames
8. Merge the subjects data frames with the measurements data frames
9. Merge the activity data frames with the measurement data frames
10. Remove variables that do not contain the keywords `mean` and `std`
11. Merge the two measurement data frames `train` and `test`
12. Create a summary table based on the subjects ID and activity ID applying the mean to the measurements
13. Write the summary table to a file



## Read the variables names
We start by reading the variables names from the file `features.txt`. This is performed by the code in the function `run_ana()`. The file is already living in the local folder, so we indicate the name of the file with the object `fileName` as shown in the snippet below. The `fileName` is used by the function `compose_features()` to start the work of processing operations: reading the file, creating a data frame, finding the variables that are duplicates, marking those duplicates in the data frame, converting those variables names in correct ones so the deuplicates are eliminated. Then, finally these variable names are removed from any character as per best practices dictate.

Once the variable names have been processed, an object `valid_column_names` will receive them to be later merged with the measurements data frames.


```r
# read common tables such as activity labels and features (column names for measurements)
  
  # read variable/column names. Also called features. 561 elements.
  # rows:  561. Matches the number of columns in the measurement datasets
  # V1:    record number
  # V2:    variable name or feature
  fileName <- "./data/UCI HAR Dataset/features.txt"
  
  # ensure valid names for the variables. Making valid_column_names GLOBAL
  # will read a table of the variable names after clean up
  # rows:             561
  # columns:          1 (returning as character vector)
  # name of column:   nice
  # env:              global
  # characteristics:  variable names. No parentheses, no duplicates, no dashes, no dots
  valid_column_names <<- compose_features(fileName)
```





## Find that all variable names are unique
The detection of unique variable names is performed inside the `compose_features()` function. 

```r
  # takes care of the proper validation of the variables names
  # features <- read.table("./data/UCI HAR Dataset/features.txt")
  features <- read.table(fileName)
  
  # convert factors to character vector
  features <- features %>%
    mutate(V2 = as.character(V2))
  
  # get counts for all rows and duplicate rows
  all_rows <- nrow(features)
  duplicate_rows <- length(features$V2[(duplicated(features$V2) | duplicated(features$V2, fromLast = TRUE))])
  list(all_rows=all_rows, duplicates=duplicate_rows)
```

```
$all_rows
[1] 561

$duplicates
[1] 126
```
We can see from the results above that there are 126 duplicate variable names out of a total of 561. We find them by using the R function `duplicated()`, reading from both sides, the beginning of the vector and from the end of the vector. We do this to force the inclusion of the original variables that were causing the repetition and not only the repeating variables. This is why the extended form of duplicated() is used: `duplicated(features$V2, fromLast = TRUE)`.


## Mark variable names that are repeating
At this point we have detected 126 duplicates. But we need a way to store the good and bad variables names for further processing. In lieue of this, we create a utility data frame called `features2` that will hold all the variable names. To mark the duplicates we add a column called `duplicate` where we store the logical status; `FALSE` if the variable is no duplicate, or `TRUE` if the variable is duplicate.


```r
  # create features with logical marker for duplicates
  features2 <- features %>%
    mutate(duplicate = FALSE) %>%    # mark the whole new column as FALSE
    mutate(duplicate = (duplicated(V2) | duplicated(V2, fromLast = TRUE)))  # mark TRUE duplicates
```

The data frame looks like this when we show just a few of the variables.

```r
features2[c(1, 100, 303, 317, 561), ]
```

```
     V1                         V2 duplicate
1     1          tBodyAcc-mean()-X     FALSE
100 100       tBodyAccJerk-iqr()-X     FALSE
303 303 fBodyAcc-bandsEnergy()-1,8      TRUE
317 317 fBodyAcc-bandsEnergy()-1,8      TRUE
561 561       angle(Z,gravityMean)     FALSE
```
It can be seen here that the rows 303 and 317, just for an example, are duplicate. If we don't remove, we could not be talking about a tidy dataset. 


## Find why the variable is repeating its name
To find out why the variables have repeating names we could take a look at the first group of variables that have this problem. The explanation is this:

* There are 126 duplicate variable names out of 561 total. These variables have something in common: they are measurements taken for three different type of bin.

* These bins have a window range with three types of steps (8, 16 and 24). And all they finish at the bin 64, for the first two, and 48 for the latter. The only thing that changes is the step. For each of these a window number is assigned.

* If we add these bins we get a total of 8, 4 and 2, or 14 bin sets. Let's see how they look:


```r
print(features2[303:319,])
```

```
     V1                           V2 duplicate
303 303   fBodyAcc-bandsEnergy()-1,8      TRUE
304 304  fBodyAcc-bandsEnergy()-9,16      TRUE
305 305 fBodyAcc-bandsEnergy()-17,24      TRUE
306 306 fBodyAcc-bandsEnergy()-25,32      TRUE
307 307 fBodyAcc-bandsEnergy()-33,40      TRUE
308 308 fBodyAcc-bandsEnergy()-41,48      TRUE
309 309 fBodyAcc-bandsEnergy()-49,56      TRUE
310 310 fBodyAcc-bandsEnergy()-57,64      TRUE
311 311  fBodyAcc-bandsEnergy()-1,16      TRUE
312 312 fBodyAcc-bandsEnergy()-17,32      TRUE
313 313 fBodyAcc-bandsEnergy()-33,48      TRUE
314 314 fBodyAcc-bandsEnergy()-49,64      TRUE
315 315  fBodyAcc-bandsEnergy()-1,24      TRUE
316 316 fBodyAcc-bandsEnergy()-25,48      TRUE
317 317   fBodyAcc-bandsEnergy()-1,8      TRUE
318 318  fBodyAcc-bandsEnergy()-9,16      TRUE
319 319 fBodyAcc-bandsEnergy()-17,24      TRUE
```
On purpose, two bin sets are included to notice the repetition. This is clear in rows 303 and 317, the variable names start repeating.


```r
print(features2[c(303,317),])
```

```
     V1                         V2 duplicate
303 303 fBodyAcc-bandsEnergy()-1,8      TRUE
317 317 fBodyAcc-bandsEnergy()-1,8      TRUE
```



## Dealing with the repeating columns
These 126 variable names are corrected by adding their bin window and the corresponding axis for the observation. There are three axis: x, y and z. For instance, if the correction by window and axis is not performed, then a variable name such as fnnxnxn() would repeat three times per axis, per bin window. There are 3 kinds of bin windows and 14 bins per axis. Since there are three axis, we end up with 14 x 3 x 3 = 126 variable names that will be finally corrected.

This is what will be done: (1) get the bin window range which has three types of steps (8, 16 and 24); (2) calculate the step and apply the corresponding bin window name (w1, w2 or w3); (3) assign the axis to a column; (4) perform the concatenation of the original variable name with its corresponding bin window name and axis. 


We find that there are 3 groups of variables:

* fBodyAcc-bandsEnergy
* fBodyAccJerk-bandsEnergy
* fBodyGyro-bandsEnergy

Each of this variables have 42 energy measurements on three different windows (w1, w2, w3), and on three different axis (X, Y, Z). These variables need to be renamed accordingly to avoid repeating name of the columns.

The windows have different resolutions: `w1` has 8 steps bins like this: 1-8, [9, 16], [17, 24], [25, 32], [33, 40], [41, 48], [49, 56] and [56, 64]. `w2` has a 16 steps bins: [1, 16], [17, 32], [33, 48] and [49, 64]. `w3` has a step of 24 bins: [1, 24] and [25, 48]; id doesn't go up to 64.

These three windows (w1, w2, w3) read over the X, Y and Z axis. To differentiate the repeating columns we will have to add the axis to each of the windows.

The following code makes possible to add the bin windows and axis for the measurement. 


```r
  # get subset of features. working only with subset of duplicates
  
  getFromLast <- function(y, m) {
    # function that gets the first or second elements -counting from the end-, of a decomposed string
    pat <- "\\,|\\-"                   # pattern is a comma or a dash
    var_list <- strsplit(y, pat)       # split the string by the pattern
    last2 <- data.frame(t(data.frame(sapply(var_list, tail, n=2))))     # get the last two elements of the list
    as.character(last2[, m])    # get character vector all rows, column "m"
  }
  
  fill_axis <- function() {
    # function to fill  rows with corresponding measurement axis
    # get a vector of X, Y, Z every fourteen
    x <- rep("x", 14); y <- rep("y", 14); z <- rep("z", 14); 
    xyz <- rep(c(x,y,z), 3)  
  }
  
  
  # operate on a dataframe of duplicates only
  features_dup <- features2 %>%
    filter(duplicate == TRUE) %>%      # duplicate features or column names
    mutate(lbin = as.integer(getFromLast(as.character(V2), 1))) %>%    # get the first bin set
    mutate(rbin = as.integer(getFromLast(as.character(V2), 2))) %>%    # get the second bin set
    mutate(window = ifelse(abs(lbin-rbin)+1 == 8, "w1", 
                           ifelse(abs(lbin-rbin)+1 == 16, "w2", 
                                  ifelse(abs(lbin-rbin)+1 == 24, "w3", "")))) %>%   # assign the bin windows
    mutate(axis = fill_axis()) %>%                                                  # assign the axis labels
    mutate(V2_new = paste(V2, window, axis, sep="-")) %>%                           # form the full name of the new column
    select(V1, V2_new)                                                              # select the id and the new column name
```

The variables after the correction will look like this:


```r
features_dup$V2[features_dup$V1 == "303" | features_dup$V1 == "317"]
```

```
[1] "fBodyAcc-bandsEnergy()-1,8-w1-x" "fBodyAcc-bandsEnergy()-1,8-w1-y"
```
This fixes the problem with the duplicate variable names. Next, is to remove the dashes, underscores, capitalization, dots from the variable names.

## Making nice variable names


```r
  # merge the original dataframe with the duplicates dataframe
  features_new <- merge(features2, features_dup, by.x = "V1", by.y = "V1", all = TRUE)
  features_new <- mutate(features_new, V2_new = ifelse(duplicate == FALSE, as.character(V2), V2_new))
  
  # convert factors to character vector
  raw_column_names <- as.character(features_new$V2_new)
  
  # ensure there are valid names for the variables. Making valid_column_names GLOBAL
  valid_column_names <<- make.names(names=raw_column_names, unique=TRUE, allow_ = TRUE)
  features_new$V2_valid <- valid_column_names
  
  # convert clean features dataframe to nice variables: no dots, no parentheses, no dash
  nice_variables <- make_nice_variables(features_new$V2_valid)
  features_new$V2_nice <- nice_variables
  
  # find if there are duplicate rows
  duplicate_rows <- duplicates(features_new$V2_nice)
  
  # set new names to final dataframe
  features_new <- features_new %>%      # proceed to rename to something human
    rename(original = V2, isduplicate = duplicate, nonduplicate = V2_new, make = V2_valid, nice = V2_nice)
  
  features_new[303:317, c("original", "nice")]    # return only one column
```

```
                        original                       nice
303   fBodyAcc-bandsEnergy()-1,8   fbodyaccbandsenergy18w1x
304  fBodyAcc-bandsEnergy()-9,16  fbodyaccbandsenergy916w1x
305 fBodyAcc-bandsEnergy()-17,24 fbodyaccbandsenergy1724w1x
306 fBodyAcc-bandsEnergy()-25,32 fbodyaccbandsenergy2532w1x
307 fBodyAcc-bandsEnergy()-33,40 fbodyaccbandsenergy3340w1x
308 fBodyAcc-bandsEnergy()-41,48 fbodyaccbandsenergy4148w1x
309 fBodyAcc-bandsEnergy()-49,56 fbodyaccbandsenergy4956w1x
310 fBodyAcc-bandsEnergy()-57,64 fbodyaccbandsenergy5764w1x
311  fBodyAcc-bandsEnergy()-1,16  fbodyaccbandsenergy116w2x
312 fBodyAcc-bandsEnergy()-17,32 fbodyaccbandsenergy1732w2x
313 fBodyAcc-bandsEnergy()-33,48 fbodyaccbandsenergy3348w2x
314 fBodyAcc-bandsEnergy()-49,64 fbodyaccbandsenergy4964w2x
315  fBodyAcc-bandsEnergy()-1,24  fbodyaccbandsenergy124w3x
316 fBodyAcc-bandsEnergy()-25,48 fbodyaccbandsenergy2548w3x
317   fBodyAcc-bandsEnergy()-1,8   fbodyaccbandsenergy18w1y
```
We can see now that the duplicate problem has been fixed. Both, the original variable name and the new name or nice, are shown side by side.



## Assign descriptive names to the train data set

## Keep only mean and std-dev variables


## Read subjects dataset

## Merging datasets
This action has 3 parts:

1. Merging the train_activities table with the activities table (with descriptive names)

2. Merging the joined table above (train_activities_inner) with the train measurments dataset.

3. Merging the subjects table with train table



# Getting the data. Acquiring the datasets

We start by downloading the zipped file containing all the datasets and associated files.
We load the library `downloader` to allow us the use of the function `download()`.

Since we want to make this analysis reproducible, we added the capability of detecting if the folder `data` exists in the folder structure. If it doesn't exist, the script will create it for the user. Downloading and extracting the files will take few minutes.


```r
library(downloader)

if(!file.exists("./data")){dir.create("./data")}

fileUrl <- "https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip"

# download(fileUrl, dest="dataset.zip", mode="wb") 
# unzip ("dataset.zip", exdir = "./data")
```

